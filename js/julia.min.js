/*
* Julia 2015.
* Copyright 2015. Julia Khusainova
*
* julia.im
* 12/27/2014
*/


(function ($) {

	$.julia = function(page) {

        this.page = '1';
        this.nextDestinationClosed = 0;

		var jPage = {

            isEmail: function(address){      
                return /^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/ig.test( address );
    
            },
				
            animateContent: function() {
                windowHeight = $(window).height();
                $(".hidden").each(function() {
                  var tst = $(this);
                  var topDistance = $(this).offset().top - windowHeight + 100;
                  $(window).scroll(function() {
                        var pos = $(window).scrollTop();
                        if( pos > topDistance ) { 
                            tst.addClass( 'show' );
                        }
                  });
                })    
                
            },
            

            //resposive menu show/hide
            animateMenu: function () {
                if ( $('#menu-dd').hasClass('closed') ) { 
                    $('#menu-dd').removeClass('closed').addClass('open');
                    $('#main').animate({'top': '180' }, 200);
                } else { 
                    $('#menu-dd').removeClass('open').addClass('closed');
                    $('#main').animate({'top': '0' }, 400);
                }
            },

            //navigation show/hide
            animateHeader: function() {
                var lastScrollTop = 0;
                $(window).scroll(function ()
                {
                    var pos = $(window).scrollTop();
                    if( pos < lastScrollTop){
                        $('header').removeClass('up').addClass('down');


                        if (jPage.page == 'story') {
                            //jPage.toogleNextDestination( $('#next-destination'), 1 );
                            $('header').addClass('down');
                        }

                        if( $('#menu-dd').hasClass('open') ) { $('#menu-dd').removeClass('up').addClass('down'); }
                    
                    } else {
                        $('header').removeClass('down').addClass('up');
                     
                        if (jPage.page == 'story') {
                            //jPage.toogleNextDestination( $('#next-destination'), 0 );
                            $('header').removeClass('down');
                        }

                        if( $('#menu-dd').hasClass('open') ) { $('#menu-dd').removeClass('down').addClass('up'); }
                    }

                    //special treatment for story pages
                    if (jPage.page == 'story') {
                        if (lastScrollTop < 700) {
                            $('header').addClass('transparent');

                            $('.featured-story').removeClass('hidden').addClass('shown');
                        } else { 
                            $('header').removeClass('transparent');

                            $('.featured-story').removeClass('shown').addClass('hidden');
                        }

                    }

                    lastScrollTop = pos;
                    if (lastScrollTop < 20) {
                        $('header').removeClass('up').addClass('down');
                        if( $('#menu-dd').hasClass('open') ) { $('#menu-dd').removeClass('up').addClass('down'); }
                    }
                });
            },


            animateShare: function() {
                $(window).scroll(function ()
                {
                    var pos = $(window).scrollTop();
                    if (pos > 700)
                    {
                        $('#share-div').addClass('fixed');
                    } else {
                        $('#share-div').removeClass('fixed');
                    }
                })
            },
            

            //next destination banner
            toogleNextDestination: function(obj, s) {

                if (s == 1) {
                    if ( obj.hasClass('up') ) {
                        obj.removeClass('up');
                    }
                    obj.addClass('down');
                    
                } else if (s == 0) {
                    if ( obj.hasClass('down') ) {
                        obj.removeClass('down');
                    }
                    obj.addClass('up');
                }
            },


            positionImages: function() {

                var $grid = $('.section-stories').masonry({
                    itemSelector: '.i-story',
                    columnWidth: '.i-story-sizer',
                    percentPosition: true
                });

                console.log(1);

    
            },



            loadPreviews: function () {

                $('img.lazy').each(function() {
                   var source = this.getAttribute('data-src');
                   this.setAttribute('src', source);
                });

                var $grid = $('.section-stories');
                $grid.imagesLoaded( function(){
                    $grid.masonry({
                        itemSelector: '.i-story',
                        percentPosition: true
                    });
                });

                //this.addEventListener('onComplete', jPage.loadPreviews(), false);
                
            },

            

            animateFeatured: function () {
                var lastScrollTop = 0;
                var featuredStoryHeader = $('.featured-story');

                $(window).scroll($.throttle(100, function () {
                    
                    var pos = $(window).scrollTop();
                    featuredStoryHeader.css({
                        transform: 'scale(' + (1 + (0.0003 * pos))+ ')'
                    });

                }));
            },

            showSubscribedMessage: function () {
                $('#subscribe-form').addClass('form-hidden');
                $('#subscribe-successful').removeClass('form-hidden').addClass('form-shown');
            },

            validateForm: function(form) {
                var $req = form.find('.required');

                if ( $req.val() === '' || (!jPage.isEmail($req.val()) ) ) {
                    $req.addClass('invalid');
                } else {
                    $req.removeClass('invalid');
                    jPage.submitForm(form);
                }
            },

            submitForm: function (form) {
                $.ajax({
                    type:   form.attr('method'),
                    url:    form.attr('action'),
                    data:   form.serialize(),
                    cache       : false,
                    dataType    : 'jsonp',
                    contentType: "application/jsonp; charset=utf-8",

                    //error       : function(err) { alert("Could not connect to the registration server. Please try again later."); },
                    success     : function(data) {
                        if (data.result != "success") {
                            console.log('Something went wrong');
                        } else {
                            jPage.showSubscribedMessage('Success!');
                            console.log('Subscribed');

                        }
                    }
                });
            },


            //not using
            fillMap: function() {
              if (document.getElementById("world-map") != null) {
                var worldMap = new Datamap({
                    element: document.getElementById("world-map"),
                    projection: 'mercator',
                    fills: {
                        defaultFill: "#eeeeee",
                        authorHasTraveledTo: "#00bcd4"
                    },
                    geographyConfig: {
                        highlightOnHover: true,
                        highlightFillColor: '#00bcd4',
                        highlightBorderColor: '#fff',
                        highlightBorderWidth: 1
                    },
                    data: {
                        USA: { fillKey: "authorHasTraveledTo" },
                        CAN: { fillKey: "authorHasTraveledTo" },
                        POL: { fillKey: "authorHasTraveledTo" },
                        FRA: { fillKey: "authorHasTraveledTo" },
                        DEU: { fillKey: "authorHasTraveledTo" },
                        SWE: { fillKey: "authorHasTraveledTo" },
                        SWS: { fillKey: "authorHasTraveledTo" },
                        GBR: { fillKey: "authorHasTraveledTo" },
                        CHN: { fillKey: "authorHasTraveledTo" },
                        IND: { fillKey: "authorHasTraveledTo" },
                        AUT: { fillKey: "authorHasTraveledTo" },
                        FIN: { fillKey: "authorHasTraveledTo" },
                        RUS: { fillKey: "authorHasTraveledTo" },
                        UKR: { fillKey: "authorHasTraveledTo" },
                        AUS: { fillKey: "authorHasTraveledTo" },
                        THA: { fillKey: "authorHasTraveledTo" },
                        ITA: { fillKey: "authorHasTraveledTo" },
                        ROU: { fillKey: "authorHasTraveledTo" },
                        BRA: { fillKey: "authorHasTraveledTo" },
                        TUR: { fillKey: "authorHasTraveledTo" },
                        COL: { fillKey: "authorHasTraveledTo" },
                        CHL: { fillKey: "authorHasTraveledTo" },
                        PHL: { fillKey: "authorHasTraveledTo" },
                        JPN: { fillKey: "authorHasTraveledTo" },
                        IRL: { fillKey: "authorHasTraveledTo" }
                    }
                });
              }
            },

            initSubscriptionForm: function() {
                var form = $('form');

                $('#mc-embedded-subscribe').click(function (e) {
                    jPage.validateForm(form);
                    return false;
                });
            },
			
			init: function(p) {

                this.page = p;

                this.animateHeader();
                this.animateContent();

                $('#menu').click( function() { jPage.animateMenu() } );
                
                switch (p) {
                    
                    case 'home':
                        break;
                    case 'projects':
                        //this.fillMap();
                        break;
                    case 'stories':
                        this.loadPreviews();
                        break;
                    case 'story':
                        this.animateFeatured();
                        this.initSubscriptionForm();
                        break;
                    case 'blog':
                        this.animateShare();
                        break;
                    case 'article':
                        break;
                }
			}
			
		};
		
		jPage.init(page);
		
	}
	
		
})(jQuery);





$(document).ready(function() {

    $('.btn-small').mouseover(function() {
        $(this).addClass('slideUp');
    }).mouseout(function() {
        $(this).removeClass('slideUp');
    });

    $('#close').click( function() {
        $('#next-destination').removeClass('down').addClass('up');
        $('header').removeClass('down');
    } );

});

